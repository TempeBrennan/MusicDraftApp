<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8" />
  <title>ğŸµ ç®€è°± â†’ MusicXML å¯è§†ç¼–è¾‘å™¨</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
    }

    header {
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header input {
      padding: 4px;
      font-size: 0.9em;
    }

    header button {
      padding: 6px 10px;
      cursor: pointer;
    }

    #main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* å·¦ä¾§é¢æ¿ */
    #note-palette {
      width: 230px;
      background: #fafafa;
      border-right: 1px solid #ddd;
      padding: 8px;
      display: flex;
      flex-direction: column;
    }

    #palette-tones {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    #palette-tones button {
      width: 30px;
      height: 30px;
      border: 1px solid #777;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
    }

    #palette-tones button.activeStep {
      background: #007bff;
      color: white;
    }

    select,
    input,
    button {
      font-size: 0.9em;
    }

    #note-palette label {
      display: block;
      margin-top: 10px;
    }

    /* ä¸­é—´å±•ç¤ºåŒº */
    #score-area {
      flex: 1;
      background: white;
      overflow: auto;
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      align-content: flex-start;
    }

    .measure {
      position: relative;
      border: 1px solid #ccc;
      min-width: 160px;
      margin: 4px;
      padding: 4px;
      border-radius: 4px;
      background: #FCFCFD;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }

    .measure::before {
      content: attr(data-num) " |";
      font-weight: bold;
      margin-right: 8px;
      color: #888;
    }

    .measure button.del-measure {
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 10px;
      background: #fee;
      border: 1px solid #c66;
      cursor: pointer;
      border-radius: 4px;
    }

    .note-block {
      width: 32px;
      height: 32px;
      border: 1px solid #aaa;
      border-radius: 4px;
      margin: 2px;
      text-align: center;
      line-height: 32px;
      cursor: pointer;
      background: #f2f2f2;
      position: relative;
    }

    .note-block.rest {
      background: #eee;
      color: #999;
    }

    .note-block.selected {
      background: #cce5ff;
      border-color: #007bff;
    }

    .note-block button.del-note {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #f66;
      color: white;
      border: none;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      line-height: 10px;
      font-size: 10px;
      cursor: pointer;
      display: none;
    }

    .note-block:hover button.del-note {
      display: block;
    }

    /* å³ä¾§å±æ€§çª— */
    #note-editor {
      width: 260px;
      background: #fafafa;
      border-left: 1px solid #ddd;
      padding: 10px;
    }

    #note-editor h4 {
      margin: 6px 0;
    }

    #note-editor label {
      display: block;
      margin: 6px 0;
    }

    #note-editor select {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }

    #updateNote {
      margin-top: 10px;
      width: 100%;
      padding: 6px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #updateNote:hover {
      background: #0069d9;
    }
  </style>
</head>

<body>
  <header>
    ğŸµ æ›²åï¼š
    <input id="titleInput" type="text" placeholder="è¯·è¾“å…¥æ›²å" style="width:180px;">
    ä½œæ›²ï¼š
    <input id="composerInput" type="text" placeholder="ä½œè€…æˆ–ä½œæ›²äºº" style="width:140px;">

    <button id="btnNewMeasure">â• æ·»åŠ å°èŠ‚</button>
    <button id="btnExportMXL">ğŸ“¦ å¯¼å‡º MXL</button>
  </header>

  <div id="main">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div id="note-palette">
      <h4>ğŸµ éŸ³ç¬¦é¢æ¿</h4>
      <div id="palette-tones">
        <button class="tone" data-step="C">1</button>
        <button class="tone" data-step="D">2</button>
        <button class="tone" data-step="E">3</button>
        <button class="tone" data-step="F">4</button>
        <button class="tone" data-step="G">5</button>
        <button class="tone" data-step="A">6</button>
        <button class="tone" data-step="B">7</button>
        <button id="restBtn">ä¼‘</button>
      </div>

      <label>å‡é™å·:
        <select id="alterSel">
          <option value="0">â™®</option>
          <option value="1">â™¯</option>
          <option value="-1">â™­</option>
        </select>
      </label>

      <label>å…«åº¦:
        <select id="octSel">
          <option>3</option>
          <option selected>4</option>
          <option>5</option>
        </select>
      </label>

      <label>æ—¶å€¼:
        <select id="durSel">
          <option value="1">å…«åˆ†</option>
          <option value="2" selected>å››åˆ†</option>
          <option value="4">äºŒåˆ†</option>
        </select>
      </label>

      <button id="addNoteBtn">æ·»åŠ éŸ³ç¬¦åˆ°å½“å‰å°èŠ‚</button>
    </div>

    <!-- ä¸­é—´å±•ç¤º -->
    <div id="score-area"></div>

    <!-- å³ä¾§å±æ€§çª— -->
    <div id="note-editor">
      <h4>ğŸšï¸ éŸ³ç¬¦å±æ€§</h4>
      <div id="noSelection">ç‚¹å‡»éŸ³ç¬¦ä»¥ç¼–è¾‘å±æ€§ã€‚</div>

      <div id="editorForm" style="display:none;">
        <label>éŸ³å:<select id="editStep">
            <option>C</option>
            <option>D</option>
            <option>E</option>
            <option>F</option>
            <option>G</option>
            <option>A</option>
            <option>B</option>
          </select></label>
        <label>å‡é™å·:<select id="editAlter">
            <option value="0">â™®</option>
            <option value="1">â™¯</option>
            <option value="-1">â™­</option>
          </select></label>
        <label>å…«åº¦:<select id="editOctave">
            <option>3</option>
            <option selected>4</option>
            <option>5</option>
          </select></label>
        <label>æ—¶å€¼:<select id="editDur">
            <option value="1">å…«åˆ†</option>
            <option value="2">å››åˆ†</option>
            <option value="4">äºŒåˆ†</option>
          </select></label>
        <label>è¿éŸ³:<select id="editSlur">
            <option value="">æ— </option>
            <option value="start">start</option>
            <option value="stop">stop</option>
          </select></label>
        <label>Beam:<select id="editBeam">
            <option value="">æ— </option>
            <option value="begin">begin</option>
            <option value="continue">continue</option>
            <option value="end">end</option>
          </select></label>
        <button id="updateNote">æ›´æ–°éŸ³ç¬¦</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- æ•°æ®ç»“æ„ ----------
    const Editor = {
      measures: [[]],
      selected: null,
    };

    // ---------- å·¥å…·å‡½æ•° ----------
    const durName = d => ({ 1: "eighth", 2: "quarter", 4: "half" }[d] || "quarter");
    const pitchToNum = s => ({ C: "1", D: "2", E: "3", F: "4", G: "5", A: "6", B: "7" }[s] || "?");

    // ---------- æ¸²æŸ“å‡½æ•° ----------
    function renderScore() {
      const area = document.getElementById('score-area');
      area.innerHTML = "";
      Editor.measures.forEach((m, mi) => {
        const mDiv = document.createElement('div');
        mDiv.className = "measure";
        mDiv.dataset.num = mi + 1;

        // åˆ é™¤å°èŠ‚
        const delM = document.createElement("button");
        delM.className = "del-measure";
        delM.textContent = "Ã—";
        delM.onclick = () => { Editor.measures.splice(mi, 1); renderScore(); };
        mDiv.appendChild(delM);

        // éŸ³ç¬¦å—
        m.forEach((n, ni) => {
          const el = document.createElement("div");
          el.className = "note-block" + (n.type === "rest" ? " rest" : "");
          el.textContent = (n.type === "rest" ? "ä¼‘" : pitchToNum(n.step));
          if (Editor.selected && Editor.selected.mi === mi && Editor.selected.ni === ni)
            el.classList.add("selected");
          // åˆ é™¤æŒ‰é’®
          const del = document.createElement("button");
          del.className = "del-note";
          del.textContent = "Ã—";
          del.onclick = e => {
            e.stopPropagation();
            m.splice(ni, 1);
            renderScore();
          };
          el.appendChild(del);
          el.onclick = () => selectNote(mi, ni, el);
          mDiv.appendChild(el);
        });

        area.appendChild(mDiv);
      });
    }

    // ---------- é€‰æ‹© & æ›´æ–°éŸ³ç¬¦ ----------
    function selectNote(mi, ni, el) {
      document.querySelectorAll(".note-block").forEach(b => b.classList.remove("selected"));
      el.classList.add("selected");
      Editor.selected = { mi, ni };
      const n = Editor.measures[mi][ni];
      document.getElementById("noSelection").style.display = "none";
      const form = document.getElementById("editorForm");
      form.style.display = "block";
      form.querySelector("#editStep").value = n.step || "C";
      form.querySelector("#editAlter").value = n.alter || 0;
      form.querySelector("#editOctave").value = n.octave || 4;
      form.querySelector("#editDur").value = n.duration || 2;
      form.querySelector("#editSlur").value = n.slur || "";
      form.querySelector("#editBeam").value = n.beam || "";
    }

    document.getElementById("updateNote").onclick = () => {
      const s = Editor.selected;
      if (!s) return;
      const n = Editor.measures[s.mi][s.ni];
      n.step = document.getElementById("editStep").value;
      n.alter = parseInt(document.getElementById("editAlter").value);
      n.octave = parseInt(document.getElementById("editOctave").value);
      n.duration = parseInt(document.getElementById("editDur").value);
      n.xml_type = durName(n.duration);
      n.slur = document.getElementById("editSlur").value || undefined;
      n.beam = document.getElementById("editBeam").value || undefined;
      renderScore();
    }

    // ---------- æ·»åŠ éŸ³ç¬¦ ----------
    document.getElementById("addNoteBtn").onclick = () => {
      const active = document.querySelector(".tone.activeStep");
      const step = active ? active.dataset.step : null;
      const alter = parseInt(document.getElementById("alterSel").value);
      const oct = parseInt(document.getElementById("octSel").value);
      const dur = parseInt(document.getElementById("durSel").value);
      const note = step
        ? { type: "note", step, alter, octave: oct, duration: dur, xml_type: durName(dur) }
        : { type: "rest", duration: dur, xml_type: durName(dur) };
      if (Editor.measures.length === 0) Editor.measures.push([]);
      Editor.measures.at(-1).push(note);
      renderScore();
    };

    // ---------- UIäº‹ä»¶ ----------
    document.querySelectorAll(".tone").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll(".tone").forEach(b => b.classList.remove("activeStep"));
        btn.classList.add("activeStep");
      };
    });
    document.getElementById("restBtn").onclick = () => {
      document.querySelectorAll(".tone").forEach(b => b.classList.remove("activeStep"));
    };

    document.getElementById("btnNewMeasure").onclick = () => {
      Editor.measures.push([]);
      renderScore();
    };

    // ---------- å¯¼å‡º MXL ----------
    document.getElementById("btnExportMXL").onclick = async () => {
      let title = document.getElementById("titleInput").value.trim() || "æœªå‘½å";
      let composer = document.getElementById("composerInput").value.trim() || "åŒ¿å";

      const body = {
        title,
        creators: { composer },
        measures: Editor.measures.map((m, i) => ({
          number: i + 1,
          bpm: 120,
          new_system: i % 4 === 0, // æ¯4å°èŠ‚æ¢è¡Œ
          notes: m
        }))
      };

      try {
        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error("æœåŠ¡å™¨è¿”å›é”™è¯¯");

        const blob = await res.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${title}.mxl`;
        a.click();
      } catch (err) {
        alert("å¯¼å‡ºå¤±è´¥ï¼š" + err.message);
      }
    };

    renderScore();
  </script>
</body>

</html>